<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <link rel="stylesheet" href="reports-style.css">
</head>
<body>
    <div class="reports-container">
        <div class="header">
            <h1>ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
            <a href="index.html" class="btn-back">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </div>

        <div class="filters-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠØŒ Ø§Ù„ÙØ±Ø¹ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®...)">
            </div>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filterBranch">ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹:</label>
                    <select id="filterBranch">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterDateFrom">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="filterDateFrom" style="padding:8px;border:2px solid #3498db;border-radius:8px;">
                </div>

                <div class="filter-group">
                    <label for="filterDateTo">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="filterDateTo" style="padding:8px;border:2px solid #3498db;border-radius:8px;">
                </div>

                <button class="btn-reset-filter" onclick="resetFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                <button class="btn-export" onclick="exportToExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                <button class="btn-clear-all" onclick="clearAllData()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                <div class="stat-value" id="totalRecords">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                <div class="stat-value" id="totalSalesSum">0 Ø±ÙŠØ§Ù„</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´</div>
                <div class="stat-value" id="totalCashSum">0 Ø±ÙŠØ§Ù„</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠ</div>
                <div class="stat-value" id="totalCardSum">0 Ø±ÙŠØ§Ù„</div>
            </div>
            <div class="stat-card stat-expenses">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
                <div class="stat-value" id="totalExpensesSum">0 Ø±ÙŠØ§Ù„</div>
            </div>
            <div class="stat-card stat-withdrawals">
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</div>
                <div class="stat-value" id="totalWithdrawalsSum">0 Ø±ÙŠØ§Ù„</div>
            </div>
        </div>

        <div class="table-container">
            <table id="reportsTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                        <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                        <th>Ø§Ù„ÙØ±Ø¹</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                        <th>Ø§Ù„ÙƒØ§Ø´</th>
                        <th>Ù…Ø¯ÙŠ</th>
                        <th>ØªÙ…Ø§Ø±Ø§</th>
                        <th>ØªØ§Ø¨ÙŠ</th>
                        <th>ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯</th>
                        <th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th>
                        <th>Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯</th>
                        <th>Ø§Ù„Ø³Ø­Ø¨</th>
                        <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr class="no-data">
                        <td colspan="13">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js"
            }
        }
    </script>
    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, getDocs, orderBy, query, deleteDoc, doc } from "firebase/firestore";

        // Ø¹Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹ Firebase â†’ Web app
       // Import the functions you need from the SDKs you need
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyA3PIfkz7RFVWYGltiyfkUmzQZ7MBPp_hs",
  authDomain: "manafed-3f18b.firebaseapp.com",
  databaseURL: "https://manafed-3f18b-default-rtdb.firebaseio.com",
  projectId: "manafed-3f18b",
  storageBucket: "manafed-3f18b.firebasestorage.app",
  messagingSenderId: "977750267755",
  appId: "1:977750267755:web:172b418b4e4ae683b79e2e"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allData = [];

        window.onload = function() {
            loadData();
        };

        async function loadData() {
            try {
                const q = query(collection(db, 'sales'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                allData = snapshot.docs.map(docSnap => {
                    const data = docSnap.data();
                    const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.clientTimestamp || Date.now());
                    return {
                        id: docSnap.id,
                        ...data,
                        createdAt
                    };
                });
                displayData(allData);
                updateStats(allData);
                populateBranchFilter();
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
            }
        }

        function displayData(data) {
            const tableBody = document.getElementById('tableBody');
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr class="no-data"><td colspan="17">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            data.forEach((record, index) => {
                const row = document.createElement('tr');
                const financingNotes = record.financingNotes && record.financingNotes !== '-' ? record.financingNotes : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª';
                const tamaraTooltip = (record.tamara && record.tamara > 0) ? `title="Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${financingNotes}" style="cursor:help;"` : '';
                const tabbyTooltip = (record.tabby && record.tabby > 0) ? `title="Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${financingNotes}" style="cursor:help;"` : '';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${record.saleDate || '-'}</td>
                    <td>${formatDateTime(record.createdAt)}</td>
                    <td>${record.employeeId}</td>
                    <td>${record.branch}</td>
                    <td>${parseFloat(record.totalSales).toFixed(2)}</td>
                    <td>${parseFloat(record.totalCash).toFixed(2)}</td>
                    <td>${parseFloat(record.totalCard).toFixed(2)}</td>
                    <td ${tamaraTooltip}>${parseFloat(record.tamara || 0).toFixed(2)}</td>
                    <td ${tabbyTooltip}>${parseFloat(record.tabby || 0).toFixed(2)}</td>
                    <td>${parseFloat(record.extraCash || 0).toFixed(2)}</td>
                    <td>${parseFloat(record.expenses).toFixed(2)}</td>
                    <td>${parseFloat(record.returns).toFixed(2)}</td>
                    <td>${parseFloat(record.withdrawal).toFixed(2)}</td>
                    <td class="notes-cell">${record.notes || '-'}</td>
                    <td>${record.attachment || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                    <td>
                        <button class="btn-view" onclick="viewDetails('${record.id}')">ğŸ‘ï¸</button>
                        <button class="btn-delete" onclick="deleteRecord('${record.id}')">ğŸ—‘ï¸</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const dateStr = date.toLocaleDateString('ar-EG');
            const timeStr = date.toLocaleTimeString('ar-EG');
            return `${dateStr}<br>${timeStr}`;
        }

        function updateStats(data) {
            document.getElementById('totalRecords').textContent = data.length;
            
            const totalSales = data.reduce((sum, record) => sum + parseFloat(record.totalSales || 0), 0);
            const totalCash = data.reduce((sum, record) => sum + parseFloat(record.totalCash || 0), 0);
            const totalCard = data.reduce((sum, record) => sum + parseFloat(record.totalCard || 0), 0);
            const totalExpenses = data.reduce((sum, record) => sum + parseFloat(record.expenses || 0), 0);
            const totalWithdrawals = data.reduce((sum, record) => sum + parseFloat(record.withdrawal || 0), 0);
            
            document.getElementById('totalSalesSum').textContent = totalSales.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalCashSum').textContent = totalCash.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalCardSum').textContent = totalCard.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalExpensesSum').textContent = totalExpenses.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalWithdrawalsSum').textContent = totalWithdrawals.toFixed(2) + ' Ø±ÙŠØ§Ù„';
        }

        function populateBranchFilter() {
            const branches = [...new Set(allData.map(record => record.branch))];
            const filterBranch = document.getElementById('filterBranch');
            filterBranch.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>';
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                filterBranch.appendChild(option);
            });
        }

        document.getElementById('searchInput').addEventListener('input', function() {
            applyFilters();
        });

        document.getElementById('filterBranch').addEventListener('change', function() {
            applyFilters();
        });

        document.getElementById('filterDateFrom').addEventListener('change', function() {
            applyFilters();
        });

        document.getElementById('filterDateTo').addEventListener('change', function() {
            applyFilters();
        });

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedBranch = document.getElementById('filterBranch').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            let filteredData = allData.filter(record => {
                const matchesSearch = searchTerm === '' || 
                    record.employeeId.toLowerCase().includes(searchTerm) ||
                    record.branch.toLowerCase().includes(searchTerm) ||
                    (record.notes && record.notes.toLowerCase().includes(searchTerm));

                const matchesBranch = selectedBranch === '' || record.branch === selectedBranch;

                let matchesDate = true;
                if (dateFrom || dateTo) {
                    const recordDate = record.saleDate || new Date(record.createdAt).toISOString().split('T')[0];
                    if (dateFrom && dateTo) {
                        matchesDate = recordDate >= dateFrom && recordDate <= dateTo;
                    } else if (dateFrom) {
                        matchesDate = recordDate >= dateFrom;
                    } else if (dateTo) {
                        matchesDate = recordDate <= dateTo;
                    }
                }

                return matchesSearch && matchesBranch && matchesDate;
            });

            displayData(filteredData);
            updateStats(filteredData);
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterBranch').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            displayData(allData);
            updateStats(allData);
        }

        window.resetFilters = resetFilters;

        function viewDetails(id) {
            const record = allData.find(r => r.id === id);
            if (!record) return;
            alert(`
ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${record.saleDate || '-'}
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(record.createdAt).toLocaleString('ar-EG')}
Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ: ${record.employeeId}
Ø§Ù„ÙØ±Ø¹: ${record.branch}
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${record.totalSales} Ø±ÙŠØ§Ù„
Ø§Ù„ÙƒØ§Ø´: ${record.totalCash} Ø±ÙŠØ§Ù„
Ù…Ø¯ÙŠ: ${record.totalCard} Ø±ÙŠØ§Ù„
ØªÙ…Ø§Ø±Ø§: ${record.tamara || 0} Ø±ÙŠØ§Ù„
ØªØ§Ø¨ÙŠ: ${record.tabby || 0} Ø±ÙŠØ§Ù„
ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯: ${record.extraCash || 0} Ø±ÙŠØ§Ù„
Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${record.expenses} Ø±ÙŠØ§Ù„
Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯: ${record.returns} Ø±ÙŠØ§Ù„
Ø§Ù„Ø³Ø­Ø¨: ${record.withdrawal} Ø±ÙŠØ§Ù„
Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${record.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯'}
Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚: ${record.attachment || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
            `);
        }

        window.viewDetails = viewDetails;

        async function deleteRecord(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
            try {
                await deleteDoc(doc(db, 'sales', id));
                allData = allData.filter(r => r.id !== id);
                displayData(allData);
                updateStats(allData);
                populateBranchFilter();
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Firebase.');
            }
        }

        window.deleteRecord = deleteRecord;

        async function clearAllData() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) return;
            if (!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª!')) return;
            try {
                await Promise.all(allData.map(record => deleteDoc(doc(db, 'sales', record.id))));
                allData = [];
                displayData(allData);
                updateStats(allData);
                populateBranchFilter();
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Firebase.');
            }
        }

        window.clearAllData = clearAllData;

        function exportToExcel() {
            if (allData.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            let csv = '\uFEFF';
            csv += 'Ø§Ù„Ø±Ù‚Ù…,ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„ÙˆÙ‚Øª,Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ,Ø§Ù„ÙØ±Ø¹,Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª,Ø§Ù„ÙƒØ§Ø´,Ù…Ø¯ÙŠ,ØªÙ…Ø§Ø±Ø§,ØªØ§Ø¨ÙŠ,ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯,Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª,Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯,Ø§Ù„Ø³Ø­Ø¨,Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª,Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚\n';

            allData.forEach((record, index) => {
                const date = new Date(record.createdAt);
                csv += `${index + 1},`;
                csv += `${record.saleDate || '-'},`;
                csv += `${date.toLocaleDateString('ar-EG')},`;
                csv += `${date.toLocaleTimeString('ar-EG')},`;
                csv += `${record.employeeId},`;
                csv += `${record.branch},`;
                csv += `${record.totalSales},`;
                csv += `${record.totalCash},`;
                csv += `${record.totalCard},`;
                csv += `${record.tamara || 0},`;
                csv += `${record.tabby || 0},`;
                csv += `${record.extraCash || 0},`;
                csv += `${record.expenses},`;
                csv += `${record.returns},`;
                csv += `${record.withdrawal},`;
                csv += `"${record.notes || '-'}",`;
                csv += `${record.attachment || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `sales_report_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.exportToExcel = exportToExcel;
    </script>
</body>
</html>
