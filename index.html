<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
        <div class="container">
        <div class="header-with-button">
            <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
            <a href="reports.html" class="btn-reports">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
        </div>

        <div class="card" id="loginCard" style="margin-bottom:20px;padding:16px;border:1px solid #e0e0e0;border-radius:12px;background:#f8f9fa;">
            <h3 style="margin-bottom:12px;color:#444;">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù</h3>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <input type="text" id="loginEmployeeId" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" style="flex:1;min-width:160px;padding:10px;border:2px solid #e0e0e0;border-radius:10px;">
                <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="flex:1;min-width:160px;padding:10px;border:2px solid #e0e0e0;border-radius:10px;">
                <button id="btnLogin" style="flex:0 0 auto;padding:12px 16px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
            <div id="loginStatus" style="margin-top:10px;color:#666;font-weight:600;">ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</div>
        </div>

        <div id="secureArea" style="display:none;">
        <form id="salesForm">
            <div class="form-group">
                <label for="employeeId">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                <input type="text" id="employeeId" name="employeeId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" required>
            </div>

            <div class="form-group">
                <label for="branch">Ø§Ù„ÙØ±Ø¹</label>
                <input type="text" id="branch" name="branch" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹" required>
            </div>

            <div class="form-group">
                <label for="saleDate" style="font-size:16px;font-weight:bold;color:#2c3e50;">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="saleDate" name="saleDate" required style="padding:14px;font-size:16px;border:3px solid #3498db;border-radius:10px;background:#e8f4fc;color:#2c3e50;font-weight:600;cursor:pointer;">
            </div>

            <div class="form-group">
                <label for="totalSales">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</label>
                <input type="number" id="totalSales" name="totalSales" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª" required>
            </div>

            <div class="form-group">
                <label for="totalCash">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                <input type="number" id="totalCash" name="totalCash" step="0.01" placeholder="Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly required>
            </div>

            <div class="form-group">
                <label for="totalCard">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠ</label>
                <input type="number" id="totalCard" name="totalCard" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠ" required>
            </div>

            <div class="form-group">
                <button type="button" id="btnToggleFinancing" style="padding:10px 20px;background:#17a2b8;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;">ğŸ’³ ØªÙ…ÙˆÙŠÙ„</button>
            </div>

            <div id="financingGroup" style="display:none;background:#f0f8ff;padding:20px;border-radius:12px;border:2px solid #17a2b8;margin:10px 0;">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #17a2b8;">
                    <img src="financing-icon.svg" alt="ØªÙ…ÙˆÙŠÙ„" style="width:48px;height:48px;">
                    <h3 style="margin:0;color:#17a2b8;font-size:20px;font-weight:bold;">Ù‚Ø³Ù… Ø§Ù„ØªÙ…ÙˆÙŠÙ„</h3>
                </div>
                
                <div class="form-group">
                    <label for="tamara">ØªÙ…Ø§Ø±Ø§</label>
                    <input type="number" id="tamara" name="tamara" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ ØªÙ…Ø§Ø±Ø§" value="0">
                </div>

                <div class="form-group">
                    <label for="tabby">ØªØ§Ø¨ÙŠ</label>
                    <input type="number" id="tabby" name="tabby" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ ØªØ§Ø¨ÙŠ" value="0">
                </div>

                <div class="form-group" id="financingNotesGroup" style="display: none;">
                    <label for="financingNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ) <span style="color: red;">*</span></label>
                    <textarea id="financingNotes" name="financingNotes" rows="3" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† ØªÙ…Ø§Ø±Ø§ Ø£Ùˆ ØªØ§Ø¨ÙŠ..."></textarea>
                </div>
            </div>

            <div class="form-group">
                <label for="extraCash">ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯</label>
                <input type="number" id="extraCash" name="extraCash" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø²Ø§Ø¦Ø¯" value="0">
            </div>

            <div class="form-group">
                <label for="expenses">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</label>
                <input type="number" id="expenses" name="expenses" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª" value="0">
            </div>

            <div class="form-group" id="notesGroup" style="display: none;">
                <label for="notes">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª) <span style="color: red;">*</span></label>
                <textarea id="notes" name="notes" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
            </div>

            <div class="form-group">
                <label for="returns">Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯</label>
                <input type="number" id="returns" name="returns" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯" value="0">
            </div>

            <div class="form-group">
                <label for="withdrawal">Ø§Ù„Ø³Ø­Ø¨ Ø§Ùˆ Ø¹Ø¬Ø²</label>
                <input type="number" id="withdrawal" name="withdrawal" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø­Ø¨" value="0">
            </div>

            <div class="form-group">
                <label for="attachment">Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù</label>
                <input type="file" id="attachment" name="attachment" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </div>

            <div class="btn-group">
                <button type="submit" class="btn-submit">Ø­ÙØ¸</button>
                <button type="reset" class="btn-reset">Ù…Ø³Ø­</button>
            </div>
        </form>

        <div class="result" id="result">
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</span>
                <span class="result-value" id="displayEmployeeId">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„ÙØ±Ø¹:</span>
                <span class="result-value" id="displayBranch">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</span>
                <span class="result-value" id="displaySales">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´:</span>
                <span class="result-value" id="displayCash">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠ:</span>
                <span class="result-value" id="displayCard">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span>
                <span class="result-value" id="displayExpenses">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯:</span>
                <span class="result-value" id="displayReturns">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ø³Ø­Ø¨:</span>
                <span class="result-value" id="displayWithdrawal">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
                <span class="result-value" id="displayNotes">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚:</span>
                <span class="result-value" id="displayAttachment">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
                <span class="result-value" id="displayTotal">0</span>
            </div>
        </div>
    </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js"
            }
        }
    </script>
    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where, limit } from "firebase/firestore";

        const firebaseConfig = {
            apiKey: "AIzaSyA3PIfkz7RFVWYGltiyfkUmzQZ7MBPp_hs",
            authDomain: "manafed-3f18b.firebaseapp.com",
            databaseURL: "https://manafed-3f18b-default-rtdb.firebaseio.com",
            projectId: "manafed-3f18b",
            storageBucket: "manafed-3f18b.firebasestorage.app",
            messagingSenderId: "977750267755",
            appId: "1:977750267755:web:172b418b4e4ae683b79e2e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const form = document.getElementById('salesForm');
        const result = document.getElementById('result');
        const expensesInput = document.getElementById('expenses');
        const notesGroup = document.getElementById('notesGroup');
        const notesInput = document.getElementById('notes');

        const loginEmployeeId = document.getElementById('loginEmployeeId');
        const loginPassword = document.getElementById('loginPassword');
        const btnLogin = document.getElementById('btnLogin');
        const loginStatus = document.getElementById('loginStatus');
        const loginCard = document.getElementById('loginCard');
        const secureArea = document.getElementById('secureArea');
        let currentEmployee = null;

        const totalSalesInput = document.getElementById('totalSales');
        const totalCardInput = document.getElementById('totalCard');
        const tamaraInput = document.getElementById('tamara');
        const tabbyInput = document.getElementById('tabby');
        const extraCashInput = document.getElementById('extraCash');
        const returnsInput = document.getElementById('returns');
        const withdrawalInput = document.getElementById('withdrawal');
        const totalCashInput = document.getElementById('totalCash');

        function calculateCash() {
            const totalSales = parseFloat(totalSalesInput.value) || 0;
            const totalCard = parseFloat(totalCardInput.value) || 0;
            const tamara = parseFloat(tamaraInput.value) || 0;
            const tabby = parseFloat(tabbyInput.value) || 0;
            const extraCash = parseFloat(extraCashInput.value) || 0;
            const expenses = parseFloat(expensesInput.value) || 0;
            const withdrawal = parseFloat(withdrawalInput.value) || 0;
            const returns = parseFloat(returnsInput.value) || 0;

            const cash = totalSales - totalCard - tamara - tabby - expenses - withdrawal - returns + extraCash;
            totalCashInput.value = cash.toFixed(2);
        }

        totalSalesInput.addEventListener('input', calculateCash);
        totalCardInput.addEventListener('input', calculateCash);
        tamaraInput.addEventListener('input', calculateCash);
        tabbyInput.addEventListener('input', calculateCash);
        extraCashInput.addEventListener('input', calculateCash);
        returnsInput.addEventListener('input', calculateCash);

        const financingNotesGroup = document.getElementById('financingNotesGroup');
        const financingNotesInput = document.getElementById('financingNotes');

        function checkFinancingNotes() {
            const tamaraValue = parseFloat(tamaraInput.value) || 0;
            const tabbyValue = parseFloat(tabbyInput.value) || 0;
            if (tamaraValue > 0 || tabbyValue > 0) {
                financingNotesGroup.style.display = 'block';
                financingNotesInput.setAttribute('required', 'required');
            } else {
                financingNotesGroup.style.display = 'none';
                financingNotesInput.removeAttribute('required');
                financingNotesInput.value = '';
            }
        }

        tamaraInput.addEventListener('input', checkFinancingNotes);
        tabbyInput.addEventListener('input', checkFinancingNotes);

        let withdrawalAlertShown = false;

        const btnToggleFinancing = document.getElementById('btnToggleFinancing');
        const financingGroup = document.getElementById('financingGroup');
        btnToggleFinancing.addEventListener('click', function() {
            if (financingGroup.style.display === 'none') {
                financingGroup.style.display = 'block';
                btnToggleFinancing.textContent = 'ğŸ’³ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ…ÙˆÙŠÙ„';
            } else {
                financingGroup.style.display = 'none';
                btnToggleFinancing.textContent = 'ğŸ’³ ØªÙ…ÙˆÙŠÙ„';
                tamaraInput.value = '0';
                tabbyInput.value = '0';
                financingNotesGroup.style.display = 'none';
                financingNotesInput.removeAttribute('required');
                financingNotesInput.value = '';
                calculateCash();
            }
        });
        expensesInput.addEventListener('input', function() {
            calculateCash();
            const expensesValue = parseFloat(this.value) || 0;
            if (expensesValue > 0) {
                notesGroup.style.display = 'block';
                notesInput.setAttribute('required', 'required');
            } else {
                notesGroup.style.display = 'none';
                notesInput.removeAttribute('required');
                notesInput.value = '';
            }
        });
        withdrawalInput.addEventListener('input', function() {
            calculateCash();
            const withdrawalValue = parseFloat(this.value) || 0;
            if (withdrawalValue > 0 && !withdrawalAlertShown) {
                alert('âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¨Ù„ÙŠØº Ù…Ø¯ÙŠØ±Ùƒ Ø¨Ø§Ù„Ù…Ø¨Ù„Øº');
                withdrawalAlertShown = true;
            }
        });

        async function saveToFirestore(recordData) {
            await addDoc(collection(db, 'sales'), {
                ...recordData,
                createdAt: serverTimestamp(),
                clientTimestamp: new Date().toISOString()
            });
        }

        function setFormEnabled(enabled) {
            const controls = Array.from(form.elements).filter(el => el.id !== 'loginEmployeeId' && el.id !== 'loginPassword' && el.id !== 'btnLogin');
            controls.forEach(el => { el.disabled = !enabled; });
        }

        btnLogin.addEventListener('click', handleLogin);
        setFormEnabled(false);
        secureArea.style.display = 'none';

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!currentEmployee) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸');
                return;
            }

            const employeeId = document.getElementById('employeeId').value;
            const branch = document.getElementById('branch').value;
            const saleDate = document.getElementById('saleDate').value;
            const totalSales = parseFloat(document.getElementById('totalSales').value) || 0;
            const totalCash = parseFloat(document.getElementById('totalCash').value) || 0;
            const totalCard = parseFloat(document.getElementById('totalCard').value) || 0;
            const tamara = parseFloat(document.getElementById('tamara').value) || 0;
            const tabby = parseFloat(document.getElementById('tabby').value) || 0;
            const extraCash = parseFloat(document.getElementById('extraCash').value) || 0;
            const expenses = parseFloat(document.getElementById('expenses').value) || 0;
            
            if ((tamara > 0 || tabby > 0) && !document.getElementById('financingNotes').value.trim()) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶Ø­ Ø³Ø¨Ø¨ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (ØªÙ…Ø§Ø±Ø§/ØªØ§Ø¨ÙŠ)');
                document.getElementById('financingNotes').focus();
                return;
            }
            
            if (expenses > 0 && !document.getElementById('notes').value.trim()) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶Ø­ Ø³Ø¨Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');
                document.getElementById('notes').focus();
                return;
            }
            const returns = parseFloat(document.getElementById('returns').value) || 0;
            const withdrawal = parseFloat(document.getElementById('withdrawal').value) || 0;
            const notes = document.getElementById('notes').value || '-';
            const attachmentInput = document.getElementById('attachment');
            const attachmentName = attachmentInput.files.length > 0 ? attachmentInput.files[0].name : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

            const total = totalCash + totalCard;

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            let confirmMessage = '===== Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª =====\n\n';
            confirmMessage += 'Ø§Ù„ÙØ±Ø¹: ' + branch + '\n';
            confirmMessage += 'Ø§Ù„ØªØ§Ø±ÙŠØ®: ' + saleDate + '\n';
            confirmMessage += 'Ø§Ù„Ù…ÙˆØ¸Ù: ' + employeeId + '\n';
            confirmMessage += '----------------------------\n';
            confirmMessage += 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ' + totalSales.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            confirmMessage += 'Ø§Ù„ÙƒØ§Ø´: ' + totalCash.toFixed(2) + ' Ø±ÙŠØ§Ù„ **\n';
            confirmMessage += 'Ù…Ø¯ÙŠ: ' + totalCard.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (tamara > 0) confirmMessage += 'ØªÙ…Ø§Ø±Ø§: ' + tamara.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (tabby > 0) confirmMessage += 'ØªØ§Ø¨ÙŠ: ' + tabby.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (extraCash > 0) confirmMessage += 'ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯: ' + extraCash.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (expenses > 0) confirmMessage += 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ' + expenses.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (returns > 0) confirmMessage += 'Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯: ' + returns.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (withdrawal > 0) confirmMessage += 'Ø§Ù„Ø³Ø­Ø¨: ' + withdrawal.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            confirmMessage += '----------------------------\n';
            confirmMessage += 'Ù‡Ù„ ØªØ¤ÙƒØ¯ Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ';

            console.log('Showing confirmation dialog...');
            const userConfirmed = confirm(confirmMessage);
            console.log('User confirmation:', userConfirmed);
            
            if (!userConfirmed) {
                console.log('User cancelled, not saving');
                return;
            }

            console.log('User confirmed, proceeding to save...');

            document.getElementById('displayEmployeeId').textContent = employeeId;
            document.getElementById('displayBranch').textContent = branch;
            document.getElementById('displaySales').textContent = totalSales.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayCash').textContent = totalCash.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayCard').textContent = totalCard.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayExpenses').textContent = expenses.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayReturns').textContent = returns.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayWithdrawal').textContent = withdrawal.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayNotes').textContent = notes;
            document.getElementById('displayAttachment').textContent = attachmentName;
            document.getElementById('displayTotal').textContent = total.toFixed(2) + ' Ø±ÙŠØ§Ù„';

            const recordData = {
                employeeId,
                branch,
                saleDate,
                totalSales,
                totalCash,
                totalCard,
                tamara,
                tabby,
                extraCash,
                expenses,
                returns,
                withdrawal,
                notes,
                financingNotes: document.getElementById('financingNotes').value || '-',
                attachment: attachmentName
            };

            try {
                console.log('Attempting to save to Firestore...', recordData);
                await saveToFirestore(recordData);
                console.log('Save successful!');
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­!');
                result.classList.add('show');
                form.reset();
                withdrawalAlertShown = false;
                notesGroup.style.display = 'none';
                notesInput.removeAttribute('required');
                financingGroup.style.display = 'none';
                financingNotesGroup.style.display = 'none';
                financingNotesInput.removeAttribute('required');
                totalCashInput.value = '';
                financingGroup.style.display = 'none';
                btnToggleFinancing.textContent = 'ğŸ’³ ØªÙ…ÙˆÙŠÙ„';
                document.getElementById('employeeId').value = currentEmployee.employeeId;
                document.getElementById('employeeId').readOnly = true;
                document.getElementById('branch').value = currentEmployee.branchName || '';
                document.getElementById('branch').readOnly = true;
                document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
                result.classList.remove('show');
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Firebase. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„.');
            }
        });

        async function handleLogin() {
            const id = loginEmployeeId.value.trim();
            const pass = loginPassword.value.trim();
            if (!id || !pass) {
                alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                return;
            }
            try {
                const qEmp = query(collection(db, 'employees'), where('employeeId', '==', id), where('password', '==', pass));
                const snap = await getDocs(qEmp);
                if (snap.empty) {
                    alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                    return;
                }
                const data = snap.docs[0].data();
                currentEmployee = { id: snap.docs[0].id, ...data };
                loginStatus.textContent = `Ù…Ø³Ø¬Ù„ ÙƒÙ€ ${data.name} - ÙØ±Ø¹: ${data.branchName || '-'}`;
                loginStatus.style.color = '#28a745';
                document.getElementById('employeeId').value = data.employeeId;
                document.getElementById('employeeId').readOnly = true;
                document.getElementById('branch').value = data.branchName || '';
                document.getElementById('branch').readOnly = true;
                setFormEnabled(true);
                secureArea.style.display = 'block';
                loginCard.style.display = 'none';
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
            }
        }

        async function bootstrapAccessIfEmpty() {
            try {
                const snap = await getDocs(query(collection(db, 'employees'), limit(1)));
                if (snap.empty) {
                    currentEmployee = { id: 'bootstrap', name: 'Setup Mode', branchName: '' };
                    loginStatus.textContent = 'ÙˆØ¶Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ Ø­Ø³Ø§Ø¨ (Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¸ÙÙŠÙ†)';
                    loginStatus.style.color = '#f39c12';
                    secureArea.style.display = 'block';
                    loginCard.style.display = 'none';
                }
            } catch (err) {
                console.error(err);
            }
        }

        form.addEventListener('reset', function() {
            result.classList.remove('show');
        });

        btnLogin.addEventListener('click', handleLogin);
        setFormEnabled(false);
        secureArea.style.display = 'none';
        bootstrapAccessIfEmpty();
    </script>
</body>
</html>