<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
        <div class="container">
        <div style="text-align:center;margin-bottom:20px;">
            <img src="logo.png" alt="Logo" style="height:65px;width:auto;">
        </div>
        <div class="header-with-button">
            <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
            <a href="reports.html" class="btn-reports">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
        </div>

        <div class="card" id="loginCard" style="margin-bottom:20px;padding:16px;border:1px solid #e0e0e0;border-radius:12px;background:#f8f9fa;">
            <h3 style="margin-bottom:12px;color:#444;">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù</h3>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <input type="text" id="loginEmployeeId" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" style="flex:1;min-width:160px;padding:10px;border:2px solid #e0e0e0;border-radius:10px;">
                <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="flex:1;min-width:160px;padding:10px;border:2px solid #e0e0e0;border-radius:10px;">
                <button id="btnLogin" style="flex:0 0 auto;padding:12px 16px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
            <div id="loginStatus" style="margin-top:10px;color:#666;font-weight:600;">ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</div>
        </div>

        <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
        <div id="welcomeCard" class="card" style="display:none;margin-bottom:20px;padding:16px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:12px;border:none;color:white;">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
                <div>
                    <h2 style="margin:0;margin-bottom:8px;font-size:24px;">ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ <span id="welcomeUserName" style="font-weight:700;color:#ffeb3b;"></span></h2>
                    <p style="margin:0;font-size:14px;opacity:0.9;">ğŸ¢ Ø§Ù„ÙØ±Ø¹: <strong id="welcomeUserBranch" style="font-weight:600;"></strong></p>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <a id="btnAdminLink" href="admin.html" class="btn-reports" style="display:none;background:linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);padding:10px 16px;text-decoration:none;border-radius:8px;color:white;font-weight:600;cursor:pointer;transition:transform 0.2s;">âš™ï¸ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
                    <button id="btnLogoutWelcome" style="padding:10px 16px;background:#d32f2f;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>

        <div id="secureArea" style="display:none;">
        <form id="salesForm">
            <div class="form-group" style="display:none;">
                <label for="employeeId">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                <input type="text" id="employeeId" name="employeeId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" required>
            </div>

            <div class="form-group" style="display:none;">
                <label for="branch">Ø§Ù„ÙØ±Ø¹</label>
                <input type="text" id="branch" name="branch" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹" required>
            </div>

            <div class="form-group">
                <label for="saleDate" style="font-size:16px;font-weight:bold;color:#2c3e50;">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="saleDate" name="saleDate" required style="padding:14px;font-size:16px;border:3px solid #3498db;border-radius:10px;background:#e8f4fc;color:#2c3e50;font-weight:600;cursor:pointer;">
            </div>

            <div class="form-group">
                <label for="totalSales">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</label>
                <input type="number" id="totalSales" name="totalSales" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª" required>
            </div>

            

            <div class="form-group">
                <label for="totalCard">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠ</label>
                <input type="number" id="totalCard" name="totalCard" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠ" required>
            </div>

           

    

            <div class="form-group">
                <label for="extraCash">ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯</label>
                <input type="number" id="extraCash" name="extraCash" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø²Ø§Ø¦Ø¯" value="0">
            </div>

            <div class="form-group">
                <label for="expenses">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</label>
                <input type="number" id="expenses" name="expenses" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª" value="0">
            </div>

            <div class="form-group" id="notesGroup" style="display: none;">
                <label for="notes">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª) <span style="color: red;">*</span></label>
                <textarea id="notes" name="notes" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
            </div>

            <div class="form-group">
                <label for="returns">Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯</label>
                <input type="number" id="returns" name="returns" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯" value="0">
            </div>
             <div class="form-group">
                <button type="button" id="btnToggleFinancing" style="padding:10px 20px;background:#17a2b8;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;">ğŸ’³ ØªÙ…ÙˆÙŠÙ„</button>
            </div>
            <div id="financingGroup" style="display:none;background:#f0f8ff;padding:20px;border-radius:12px;border:2px solid #17a2b8;margin:10px 0;">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #17a2b8;">
                    <img src="financing-icon.svg" alt="ØªÙ…ÙˆÙŠÙ„" style="width:48px;height:48px;">
                    <h3 style="margin:0;color:#17a2b8;font-size:20px;font-weight:bold;">Ù‚Ø³Ù… Ø§Ù„ØªÙ…ÙˆÙŠÙ„</h3>
                </div>
                
                <div class="form-group">
                    <label for="tamara">ØªÙ…Ø§Ø±Ø§</label>
                    <input type="number" id="tamara" name="tamara" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ ØªÙ…Ø§Ø±Ø§" value="0">
                </div>

                <div class="form-group">
                    <label for="tabby">ØªØ§Ø¨ÙŠ</label>
                    <input type="number" id="tabby" name="tabby" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ ØªØ§Ø¨ÙŠ" value="0">
                </div>

                <div class="form-group" id="financingNotesGroup" style="display: none;">
                    <label for="financingNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ) <span style="color: red;">*</span></label>
                    <textarea id="financingNotes" name="financingNotes" rows="3" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† ØªÙ…Ø§Ø±Ø§ Ø£Ùˆ ØªØ§Ø¨ÙŠ..."></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="totalCash">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                <input type="number" id="totalCash" name="totalCash" step="0.01" placeholder="Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly required>
            </div>
            <div class="form-group">
                <label for="withdrawal">Ø§Ù„Ø³Ø­Ø¨ Ø§Ùˆ Ø¹Ø¬Ø²</label>
                <input type="number" id="withdrawal" name="withdrawal" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø­Ø¨" value="0">
            </div>

            <div class="form-group">
                <label for="attachment">Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù Ù…Ù† Google Drive</label>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button type="button" id="btnGoogleDrive" style="flex:1;min-width:150px;padding:12px 16px;background:#4285f4;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:background 0.3s;" onmouseover="this.style.background='#357ae8'" onmouseout="this.style.background='#4285f4'">ğŸ“ Ø§Ø®ØªØ± Ù…Ù† Google Drive</button>
                </div>
                <div id="selectedFileInfo" style="margin-top:10px;padding:10px;background:#f0f0f0;border-radius:8px;display:none;border-left:4px solid #4285f4;">
                    <p style="margin:0;font-size:14px;color:#333;"><strong>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±:</strong> <span id="selectedFileName" style="color:#4285f4;font-weight:600;"></span></p>
                    <p style="margin:5px 0 0 0;font-size:12px;color:#666;">Ø§Ù„Ø±Ø§Ø¨Ø·: <a id="selectedFileLink" href="#" target="_blank" style="color:#4285f4;text-decoration:none;">ÙØªØ­ Ø§Ù„Ù…Ù„Ù</a></p>
                </div>
                <input type="hidden" id="attachment" name="attachment">
                <input type="hidden" id="attachmentFileId" name="attachmentFileId">
                <input type="hidden" id="attachmentFileName" name="attachmentFileName">
            </div>

            <div class="btn-group">
                <button type="submit" class="btn-submit">Ø­ÙØ¸</button>
                <button type="reset" class="btn-reset">Ù…Ø³Ø­</button>
            </div>
        </form>

        <div class="result" id="result">
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</span>
                <span class="result-value" id="displayEmployeeId">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„ÙØ±Ø¹:</span>
                <span class="result-value" id="displayBranch">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</span>
                <span class="result-value" id="displaySales">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´:</span>
                <span class="result-value" id="displayCash">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙŠ:</span>
                <span class="result-value" id="displayCard">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span>
                <span class="result-value" id="displayExpenses">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯:</span>
                <span class="result-value" id="displayReturns">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ø³Ø­Ø¨:</span>
                <span class="result-value" id="displayWithdrawal">0</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
                <span class="result-value" id="displayNotes">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚:</span>
                <span class="result-value" id="displayAttachment">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
            </div>
            <div class="result-item">
                <span class="result-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
                <span class="result-value" id="displayTotal">0</span>
            </div>
        </div>
    </div>
    </div>

    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js"
            }
        }
    </script>
    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where, limit } from "firebase/firestore";

        const firebaseConfig = {
            apiKey: "AIzaSyA3PIfkz7RFVWYGltiyfkUmzQZ7MBPp_hs",
            authDomain: "manafed-3f18b.firebaseapp.com",
            databaseURL: "https://manafed-3f18b-default-rtdb.firebaseio.com",
            projectId: "manafed-3f18b",
            storageBucket: "manafed-3f18b.firebasestorage.app",
            messagingSenderId: "977750267755",
            appId: "1:977750267755:web:172b418b4e4ae683b79e2e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const form = document.getElementById('salesForm');
        const result = document.getElementById('result');
        const expensesInput = document.getElementById('expenses');
        const notesGroup = document.getElementById('notesGroup');
        const notesInput = document.getElementById('notes');

        const loginEmployeeId = document.getElementById('loginEmployeeId');
        const loginPassword = document.getElementById('loginPassword');
        const btnLogin = document.getElementById('btnLogin');
        const loginStatus = document.getElementById('loginStatus');
        const loginCard = document.getElementById('loginCard');
        const secureArea = document.getElementById('secureArea');
        const welcomeCard = document.getElementById('welcomeCard');
        const btnLogoutWelcome = document.getElementById('btnLogoutWelcome');
        let currentEmployee = null;

        const totalSalesInput = document.getElementById('totalSales');
        const totalCardInput = document.getElementById('totalCard');
        const tamaraInput = document.getElementById('tamara');
        const tabbyInput = document.getElementById('tabby');
        const extraCashInput = document.getElementById('extraCash');
        const returnsInput = document.getElementById('returns');
        const withdrawalInput = document.getElementById('withdrawal');
        const totalCashInput = document.getElementById('totalCash');

        function calculateCash() {
            const totalSales = parseFloat(totalSalesInput.value) || 0;
            const totalCard = parseFloat(totalCardInput.value) || 0;
            const tamara = parseFloat(tamaraInput.value) || 0;
            const tabby = parseFloat(tabbyInput.value) || 0;
            const extraCash = parseFloat(extraCashInput.value) || 0;
            const expenses = parseFloat(expensesInput.value) || 0;
            const withdrawal = parseFloat(withdrawalInput.value) || 0;
            const returns = parseFloat(returnsInput.value) || 0;

            const cash = totalSales - totalCard - tamara - tabby - expenses - withdrawal - returns + extraCash;
            totalCashInput.value = cash.toFixed(2);
        }

        totalSalesInput.addEventListener('input', calculateCash);
        totalCardInput.addEventListener('input', calculateCash);
        tamaraInput.addEventListener('input', calculateCash);
        tabbyInput.addEventListener('input', calculateCash);
        extraCashInput.addEventListener('input', calculateCash);
        returnsInput.addEventListener('input', calculateCash);

        const financingNotesGroup = document.getElementById('financingNotesGroup');
        const financingNotesInput = document.getElementById('financingNotes');

        function checkFinancingNotes() {
            const tamaraValue = parseFloat(tamaraInput.value) || 0;
            const tabbyValue = parseFloat(tabbyInput.value) || 0;
            if (tamaraValue > 0 || tabbyValue > 0) {
                financingNotesGroup.style.display = 'block';
                financingNotesInput.setAttribute('required', 'required');
            } else {
                financingNotesGroup.style.display = 'none';
                financingNotesInput.removeAttribute('required');
                financingNotesInput.value = '';
            }
        }

        tamaraInput.addEventListener('input', checkFinancingNotes);
        tabbyInput.addEventListener('input', checkFinancingNotes);

        let withdrawalAlertShown = false;

        const btnToggleFinancing = document.getElementById('btnToggleFinancing');
        const financingGroup = document.getElementById('financingGroup');
        btnToggleFinancing.addEventListener('click', function() {
            if (financingGroup.style.display === 'none') {
                financingGroup.style.display = 'block';
                btnToggleFinancing.textContent = 'ğŸ’³ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ…ÙˆÙŠÙ„';
            } else {
                financingGroup.style.display = 'none';
                btnToggleFinancing.textContent = 'ğŸ’³ ØªÙ…ÙˆÙŠÙ„';
                tamaraInput.value = '0';
                tabbyInput.value = '0';
                financingNotesGroup.style.display = 'none';
                financingNotesInput.removeAttribute('required');
                financingNotesInput.value = '';
                calculateCash();
            }
        });
        expensesInput.addEventListener('input', function() {
            calculateCash();
            const expensesValue = parseFloat(this.value) || 0;
            if (expensesValue > 0) {
                notesGroup.style.display = 'block';
                notesInput.setAttribute('required', 'required');
            } else {
                notesGroup.style.display = 'none';
                notesInput.removeAttribute('required');
                notesInput.value = '';
            }
        });
        withdrawalInput.addEventListener('input', function() {
            calculateCash();
            const withdrawalValue = parseFloat(this.value) || 0;
            if (withdrawalValue > 0 && !withdrawalAlertShown) {
                alert('âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¨Ù„ÙŠØº Ù…Ø¯ÙŠØ±Ùƒ Ø¨Ø§Ù„Ù…Ø¨Ù„Øº');
                withdrawalAlertShown = true;
            }
        });

        async function saveToFirestore(recordData) {
            await addDoc(collection(db, 'sales'), {
                ...recordData,
                createdAt: serverTimestamp(),
                clientTimestamp: new Date().toISOString()
            });
        }

        function setFormEnabled(enabled) {
            const controls = Array.from(form.elements).filter(el => el.id !== 'loginEmployeeId' && el.id !== 'loginPassword' && el.id !== 'btnLogin');
            controls.forEach(el => { el.disabled = !enabled; });
        }

        btnLogin.addEventListener('click', handleLogin);
        setFormEnabled(false);
        secureArea.style.display = 'none';

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!currentEmployee) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸');
                return;
            }

            const employeeId = document.getElementById('employeeId').value;
            const branch = document.getElementById('branch').value;
            const saleDate = document.getElementById('saleDate').value;
            const totalSales = parseFloat(document.getElementById('totalSales').value) || 0;
            const totalCash = parseFloat(document.getElementById('totalCash').value) || 0;
            const totalCard = parseFloat(document.getElementById('totalCard').value) || 0;
            const tamara = parseFloat(document.getElementById('tamara').value) || 0;
            const tabby = parseFloat(document.getElementById('tabby').value) || 0;
            const extraCash = parseFloat(document.getElementById('extraCash').value) || 0;
            const expenses = parseFloat(document.getElementById('expenses').value) || 0;
            
            if ((tamara > 0 || tabby > 0) && !document.getElementById('financingNotes').value.trim()) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶Ø­ Ø³Ø¨Ø¨ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (ØªÙ…Ø§Ø±Ø§/ØªØ§Ø¨ÙŠ)');
                document.getElementById('financingNotes').focus();
                return;
            }
            
            if (expenses > 0 && !document.getElementById('notes').value.trim()) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶Ø­ Ø³Ø¨Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');
                document.getElementById('notes').focus();
                return;
            }
            const returns = parseFloat(document.getElementById('returns').value) || 0;
            const withdrawal = parseFloat(document.getElementById('withdrawal').value) || 0;
            const notes = document.getElementById('notes').value || '-';
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Google Drive
            const attachmentFileName = document.getElementById('attachmentFileName').value;
            const attachmentFileId = document.getElementById('attachmentFileId').value;
            const attachmentName = attachmentFileName || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

            const total = totalCash + totalCard;

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            let confirmMessage = '===== Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª =====\n\n';
            confirmMessage += 'Ø§Ù„ÙØ±Ø¹: ' + branch + '\n';
            confirmMessage += 'Ø§Ù„ØªØ§Ø±ÙŠØ®: ' + saleDate + '\n';
            confirmMessage += 'Ø§Ù„Ù…ÙˆØ¸Ù: ' + employeeId + '\n';
            confirmMessage += '----------------------------\n';
            confirmMessage += 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ' + totalSales.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            confirmMessage += 'Ø§Ù„ÙƒØ§Ø´: ' + totalCash.toFixed(2) + ' Ø±ÙŠØ§Ù„ **\n';
            confirmMessage += 'Ù…Ø¯ÙŠ: ' + totalCard.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (tamara > 0) confirmMessage += 'ØªÙ…Ø§Ø±Ø§: ' + tamara.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (tabby > 0) confirmMessage += 'ØªØ§Ø¨ÙŠ: ' + tabby.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (extraCash > 0) confirmMessage += 'ÙƒØ§Ø´ Ø²Ø§Ø¦Ø¯: ' + extraCash.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (expenses > 0) confirmMessage += 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ' + expenses.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (returns > 0) confirmMessage += 'Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯: ' + returns.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            if (withdrawal > 0) confirmMessage += 'Ø§Ù„Ø³Ø­Ø¨: ' + withdrawal.toFixed(2) + ' Ø±ÙŠØ§Ù„\n';
            confirmMessage += '----------------------------\n';
            confirmMessage += 'Ù‡Ù„ ØªØ¤ÙƒØ¯ Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ';

            console.log('Showing confirmation dialog...');
            const userConfirmed = confirm(confirmMessage);
            console.log('User confirmation:', userConfirmed);
            
            if (!userConfirmed) {
                console.log('User cancelled, not saving');
                return;
            }

            console.log('User confirmed, proceeding to save...');

            document.getElementById('displayEmployeeId').textContent = employeeId;
            document.getElementById('displayBranch').textContent = branch;
            document.getElementById('displaySales').textContent = totalSales.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayCash').textContent = totalCash.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayCard').textContent = totalCard.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayExpenses').textContent = expenses.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayReturns').textContent = returns.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayWithdrawal').textContent = withdrawal.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('displayNotes').textContent = notes;
            document.getElementById('displayAttachment').textContent = attachmentName;
            document.getElementById('displayTotal').textContent = total.toFixed(2) + ' Ø±ÙŠØ§Ù„';

            const recordData = {
                employeeId,
                branch,
                saleDate,
                totalSales,
                totalCash,
                totalCard,
                tamara,
                tabby,
                extraCash,
                expenses,
                returns,
                withdrawal,
                notes,
                financingNotes: document.getElementById('financingNotes').value || '-',
                attachment: attachmentName,
                attachmentFileId: attachmentFileId || null,
                attachmentLink: attachmentFileId ? `https://drive.google.com/file/d/${attachmentFileId}/view` : null
            };

            try {
                console.log('Attempting to save to Firestore...', recordData);
                await saveToFirestore(recordData);
                console.log('Save successful!');
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­!');
                result.classList.add('show');
                form.reset();
                withdrawalAlertShown = false;
                notesGroup.style.display = 'none';
                notesInput.removeAttribute('required');
                financingGroup.style.display = 'none';
                financingNotesGroup.style.display = 'none';
                financingNotesInput.removeAttribute('required');
                totalCashInput.value = '';
                financingGroup.style.display = 'none';
                btnToggleFinancing.textContent = 'ğŸ’³ ØªÙ…ÙˆÙŠÙ„';
                document.getElementById('employeeId').value = currentEmployee.employeeId;
                document.getElementById('employeeId').readOnly = true;
                document.getElementById('branch').value = currentEmployee.branchName || '';
                document.getElementById('branch').readOnly = true;
                document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
                // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Google Drive
                document.getElementById('attachmentFileId').value = '';
                document.getElementById('attachmentFileName').value = '';
                document.getElementById('selectedFileInfo').style.display = 'none';
                document.getElementById('selectedFileName').textContent = '';
                result.classList.remove('show');
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Firebase. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„.');
            }
        });

        async function handleLogin() {
            const id = loginEmployeeId.value.trim();
            const pass = loginPassword.value.trim();
            if (!id || !pass) {
                alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                return;
            }
            try {
                const qEmp = query(collection(db, 'employees'), where('employeeId', '==', id), where('password', '==', pass));
                const snap = await getDocs(qEmp);
                if (snap.empty) {
                    alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                    return;
                }
                const data = snap.docs[0].data();
                currentEmployee = { id: snap.docs[0].id, ...data };
                loginStatus.textContent = `Ù…Ø³Ø¬Ù„ ÙƒÙ€ ${data.name} - ÙØ±Ø¹: ${data.branchName || '-'}`;
                loginStatus.style.color = '#28a745';
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
                document.getElementById('welcomeUserName').textContent = data.name;
                document.getElementById('welcomeUserBranch').textContent = data.branchName || '-';
                welcomeCard.style.display = 'block';
                
                // Ø¹Ø±Ø¶ Ø²Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡
                const adminBtn = document.getElementById('btnAdminLink');
                if (data.permissions && data.permissions.includes('manageEmployees')) {
                    adminBtn.style.display = 'inline-block';
                } else {
                    adminBtn.style.display = 'none';
                }
                
                document.getElementById('employeeId').value = data.employeeId;
                document.getElementById('employeeId').readOnly = true;
                document.getElementById('branch').value = data.branchName || '';
                document.getElementById('branch').readOnly = true;
                setFormEnabled(true);
                secureArea.style.display = 'block';
                loginCard.style.display = 'none';
            } catch (err) {
                console.error(err);
                alert('ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
            }
        }

        async function bootstrapAccessIfEmpty() {
            try {
                const snap = await getDocs(query(collection(db, 'employees'), limit(1)));
                if (snap.empty) {
                    currentEmployee = { id: 'bootstrap', name: 'Setup Mode', branchName: '' };
                    loginStatus.textContent = 'ÙˆØ¶Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ Ø­Ø³Ø§Ø¨ (Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¸ÙÙŠÙ†)';
                    loginStatus.style.color = '#f39c12';
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    document.getElementById('welcomeUserName').textContent = 'Setup Mode';
                    document.getElementById('welcomeUserBranch').textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹';
                    welcomeCard.style.display = 'block';
                    
                    secureArea.style.display = 'block';
                    loginCard.style.display = 'none';
                }
            } catch (err) {
                console.error(err);
            }
        }

        // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
        btnLogoutWelcome.addEventListener('click', function() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                currentEmployee = null;
                loginStatus.textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„';
                loginStatus.style.color = '#666';
                welcomeCard.style.display = 'none';
                secureArea.style.display = 'none';
                loginCard.style.display = 'block';
                loginEmployeeId.value = '';
                loginPassword.value = '';
                form.reset();
                setFormEnabled(false);
            }
        });

        form.addEventListener('reset', function() {
            result.classList.remove('show');
        });

        btnLogin.addEventListener('click', handleLogin);
        setFormEnabled(false);

        // Google Drive Integration
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù€ Client ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Google Cloud Console
        const GOOGLE_CLIENT_ID = '1035871153322-blaqsn0jds9at16k1ucpeoa0f4vce073.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyDnZ2dkhtkouVaRIw4Pi1krSeFS71e8jGg';
        let pickerInited = false;
        let gauth;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµØ­ÙŠØ­
        function checkGoogleDriveSetup() {
            if (GOOGLE_CLIENT_ID.includes('YOUR_') || GOOGLE_API_KEY.includes('YOUR_')) {
                console.warn('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Google Drive!');
                alert('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¨ÙŠØ§Ù†Ø§Øª Google Drive Ù„Ù… ØªÙØ­Ø¯Ù‘Ø« Ø¨Ø¹Ø¯!\n\nØ§Ù‚Ø±Ø£ Ù…Ù„Ù: FIX_AUTHORIZATION_ERROR.md');
            } else {
                console.log('âœ… Ø¨ÙŠØ§Ù†Ø§Øª Google Drive Ù…Ø­Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        function initGooglePicker() {
            gapi.load('auth', {'callback': onAuthApiLoad});
            gapi.load('picker', {'callback': onPickerApiLoad});
        }

        function onAuthApiLoad() {
            window.gapi.auth.authorize({
                'client_id': GOOGLE_CLIENT_ID,
                'scope': ['https://www.googleapis.com/auth/drive.readonly'],
                'immediate': false
            }, handleAuthResult);
        }

        function handleAuthResult(authResult) {
            if (authResult && !authResult.error) {
                pickerInited = true;
            } else if (authResult && authResult.error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authResult.error);
                
                // Ø±Ø³Ø§Ø¦Ù„ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„Ø©
                if (authResult.error === 'access_denied') {
                    alert('â›” ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„. Ù‚Ø¯ Ù„Ø§ ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Google Drive ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
                } else if (authResult.error === 'invalid_client') {
                    alert('âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google:\n\n1. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« GOOGLE_CLIENT_ID\n2. ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ù…Ø³Ø¬Ù„ ÙÙŠ Google Cloud Console\n3. Ø§Ù‚Ø±Ø£ Ù…Ù„Ù: FIX_AUTHORIZATION_ERROR.md');
                } else if (authResult.error === 'invalid_request' || authResult.error === 'origin_mismatch' || authResult.error === 'Permission denied') {
                    alert('âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OAuth:\n\n1. Ø§Ù‚Ø±Ø£: FIX_ERROR_400_INVALID_REQUEST.md Ø£Ùˆ QUICK_ERROR_FIX.md\n2. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ OAuth Consent Screen Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­\n3. Ø³Ø¬Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ ÙÙŠ Authorized JavaScript origins\n4. Ø§Ù†ØªØ¸Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                } else {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ' + authResult.error + '\n\nØ§Ù‚Ø±Ø£ Ù…Ù„Ù: FIX_AUTHORIZATION_ERROR.md Ù„Ù„Ø­Ù„');
                }
            }
        }

        function onPickerApiLoad() {
            pickerInited = true;
            checkGoogleDriveSetup();
        }

        function createPicker() {
            if (!pickerInited) {
                initGooglePicker();
                return;
            }

            const token = gapi.auth.getToken();
            if (!token) {
                gapi.auth.authorize({
                    'client_id': GOOGLE_CLIENT_ID,
                    'scope': ['https://www.googleapis.com/auth/drive.readonly'],
                    'immediate': false
                }, handleAuthResult);
                return;
            }

            const view = new google.picker.View(google.picker.ViewId.DOCS);
            view.setMimeTypes(['image/jpeg', 'image/png', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']);

            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN)
                .setAppId(GOOGLE_CLIENT_ID.split('.')[0])
                .setOAuthToken(token.access_token)
                .addView(view)
                .setDeveloperKey(GOOGLE_API_KEY)
                .setCallback(pickerCallback)
                .build();

            picker.setVisible(true);
        }

        function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                const fileData = data.docs[0];
                document.getElementById('attachmentFileId').value = fileData.id;
                document.getElementById('attachmentFileName').value = fileData.name;
                document.getElementById('selectedFileName').textContent = fileData.name;
                document.getElementById('selectedFileLink').href = 'https://drive.google.com/file/d/' + fileData.id + '/view';
                document.getElementById('selectedFileInfo').style.display = 'block';
            }
        }

        // Ø²Ø± Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Google Drive
        document.getElementById('btnGoogleDrive').addEventListener('click', function(e) {
            e.preventDefault();
            createPicker();
        });
    
        secureArea.style.display = 'none';
        bootstrapAccessIfEmpty();
    </script>

    <footer style="position:fixed;bottom:0;left:0;right:0;text-align:center;padding:15px;background:#f8f9fa;border-top:2px solid #e0e0e0;color:#666;font-size:14px;">
        Â© 2026 Copy Right by Mazen Algarne. All rights reserved.
    </footer>
</body>
</html>